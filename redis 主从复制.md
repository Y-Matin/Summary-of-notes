### redis 主从复制


redis的主从复制原理

1、从库向主库发送sync命令，也就是从库向主库发送同步请求；
 2、当主库接受到sync命令后，会执行bgsave命令(保存此刻主库的一个快照)，创建一个RDB文件，创建RDB文件期间主库上的执行过的命令都会被保存到缓冲区中；
 3、当主库执行完bgsave时，会向从库发送RDB文件，从库接受该文件并加载该文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态；
 4、主库将缓冲区的所有写命令发给从库执行；
 5、至此可以认为redis主从建立成功，之后主库的每一个写命令都会传到从库上执行。

  复制原理说明：
 master创建RDB文件是通过一个子进程进行的，所以master依然可以处理客户端发来的请求。但这也导致了在保存RDB文件期间，“键空间”可能发生变化（譬如接收到一个客户端请求，执行”set name diaocow”命令），因此为了保证数据同步的一致性，master会在保存RDB文件期间，把接受到的这些可能变更数据库“键空间”的命令保存到缓冲区中。


 Redis主从建立过程

说明：
 redis目前的复制是异步的，只保证最终一致性，而不是强一致性。具体的可以理解为：主库上的写命令操作后传到从库再重现一遍，从库执行完后主从是完全同步的，这是最终一致性；如果主库上的写命令传到从库上执行成功后，主库上才会反馈该命令执行成功，那么这是强一致性。

命令传播
 在上面的同步操作执行完毕后，主从库的状态就是一致的了，但这种一致并不是一致不变的。每当主服务器接收到一个写命令时，主服务器的数据就会发生改变，而从服务器并没有接收到该命令。所以为了保证主从的一致，需要主服务器将写命令传播到从服务器上，在从服务器上实现一遍，这样主从就始终一致了。